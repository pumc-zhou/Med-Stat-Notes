{
  "hash": "303aa054a3e0798e805a4f802f90e1f0",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"处理一份医疗数据\"\nnumber-sections: false\ntoc: false\ndate: \"2025-02-21\"\njupyter: python3\n---\n\n\n\n\n\n\n# 用Python处理卫生费用数据\n\n本篇博客用来记录2025年1月到2月帮助学弟处理一份某二级医院2018-2023年的医疗费用，最开始用的Stata，但是越往后，越感觉到Stata的难用，以及AI对这种程序的支持程度极其有限，随改用Python来继续完成相关的分析。\n\n## 必须配置\n\n运行此文档需要电脑上以安装Python，并且下列包已被安装并且能被调用：\n\n`jupyter-cache`,`pandas`,`openpuxl`\n\n你可以使用 `pip` 或 `conda` 进行安装： `pip install jupyter-cache`\n\n## 初步认识数据\n\n我们可以使用`pandas`包来查看部分原始数据，数据的基本样式如下：\n\n::: {#e0213e9e .cell execution_count=2}\n``` {.python .cell-code}\n# 安装并加载必要的包\nimport pandas as pd\n\n# 导入 Excel 文件\nfile_path = \"C:/Users/asus/Desktop/test/stata/prepare.xlsx\"\ndata = pd.read_excel(file_path, sheet_name=0)\n\n# 随机抽取10个样本数据\nsample_data = data.sample(n=10)\n\n# 打印样本数据\nprint(sample_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      次数        出生日期 性别   年龄      医疗付费方式  国籍 新生儿出生体重 新生儿入院体重        出生地  \\\n650    1  1953-09-11  男  64岁    新型农村合作医疗  中国       －       －  福建省莆田市仙游县   \n591    1  1973-12-12  男  44岁    新型农村合作医疗  中国       －       －      福建莆田市   \n223    2  2010-08-06  男   7岁    新型农村合作医疗  中国       －       －  福建省莆田市荔城区   \n1390   1  1973-09-01  女  45岁    新型农村合作医疗  中国       －       －      福建莆田市   \n2161   1  1979-07-18  男  39岁  城镇居民基本医疗保险  中国       －       －  福建省莆田市秀屿区   \n1433   1  1950-06-07  女  68岁    新型农村合作医疗  中国       －       －      福建莆田市   \n1520   1  1980-04-08  男  38岁  城镇职工基本医疗保险  中国       －       －      福建莆田市   \n2043   1  1973-12-14  男  44岁  城镇居民基本医疗保险  中国       －       －        福建省   \n1681   1  1984-10-19  女  34岁         全自费  中国       －       －      福建仙游县   \n1229   1  1976-10-21  男  41岁  城镇居民基本医疗保险  中国       －       －     福建省莆田市   \n\n             籍贯  ... 麻醉开始时间3 麻醉结束时间3 麻醉方式3 麻醉分级3 切口部位3 切口等级3  NNIS分级3 手术部位感染3  \\\n650   福建省莆田市仙游县  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n591          莆田  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n223      福建省莆田市  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n1390      福建莆田市  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n2161  福建省莆田市秀屿区  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n1433       福建莆田  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n1520       福建莆田  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n2043        福建省  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n1681      福建仙游县  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n1229     福建省莆田市  ...     NaN     NaN   NaN   NaN   NaN   NaN      NaN     NaN   \n\n     术前住院天数3  手术持续时间3  \n650      NaN      NaN  \n591      NaN      NaN  \n223      NaN      NaN  \n1390     NaN      NaN  \n2161     NaN      NaN  \n1433     NaN      NaN  \n1520     NaN      NaN  \n2043     NaN      NaN  \n1681     NaN      NaN  \n1229     NaN      NaN  \n\n[10 rows x 202 columns]\n```\n:::\n:::\n\n\n我们可以看到，该数据的列很多，第一张表中有220列，我们需要对其进行一些筛选。\n\n## 对数据的思考\n\n从哪里开始是一个需要思考的问题，对于数据的认识决定了你处理问题的方向和效率。首先，理解数据的来源至关重要，这包括了解数据是如何收集的、收集过程中可能出现的偏差或错误。其次，明确数据的类型与结构也是关键步骤之一，不同类型的数据（如定量数据、定性数据）需要采用不同的分析方法。再者，对数据进行初步探索，比如通过可视化手段观察数据分布特征，或是计算一些基本统计量来了解数据的基本情况，能够帮助你更好地制定数据处理策略。\n\n在真正开始处理数据之前，还需要考虑你的目标是什么。是为了回答一个具体的问题，还是为了探索潜在的模式？明确了目标之后，才能有针对性地选择合适的工具和技术。此外，考虑到数据质量的问题，数据清洗是不可跳过的一步，它包括去除异常值、填补缺失值等操作，这对于提高分析结果的准确性非常关键。\n\n最后，保持对数据伦理的关注同样重要，在整个数据分析的过程中，确保遵循相关的隐私保护法规和道德标准，这样才能确保你的工作不仅有效，而且负责任。通过对数据全面而深刻的理解，你可以更加自信地从数据中提取有价值的信息，并为决策提供有力支持。\n\n### 合并数据\n\n这份Excel文件有6张sheet，分别是2018-2023年，首先需要检查这六张sheet中的变量是否一致：\n\n::: {#0e1d383c .cell execution_count=3}\n``` {.python .cell-code}\nimport pandas as pd\n\n# 导入 Excel 文件\nfile_path = \"C:/Users/asus/Desktop/test/stata/prepare.xlsx\"\nsheet_names = [\"2018\", \"2019\", \"2020\", \"2021\", \"2022\", \"2023\"]\n\n# 读取所有 sheet 的数据\nsheets_data = {sheet: pd.read_excel(file_path, sheet_name=sheet) for sheet in sheet_names}\n\n# 获取每个 sheet 的列名\nsheets_columns = {sheet: set(data.columns) for sheet, data in sheets_data.items()}\n\n# 找出所有 sheet 的共同变量和不一致的变量\ncommon_columns = set.intersection(*sheets_columns.values())\nall_columns = set.union(*sheets_columns.values())\ninconsistent_columns = all_columns - common_columns\n\n# 打印结果\nprint(\"一致的变量名:\")\nprint(common_columns)\n\nprint(\"\\n不一致的变量名:\")\nprint(inconsistent_columns)\n\n# 打印每个 sheet 的变量\nfor sheet, columns in sheets_columns.items():\n    print(f\"\\n{sheet} 的变量: {columns}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n一致的变量名:\n{'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '术前使用预防性抗菌药物2', '3.4麻醉费', '是否有出院31天内再住院计划', '3级别', '1手术时间', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '2麻醉方式', '病理诊断', '3切口', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '1.2一般治疗操作费', '4级别', '6级别', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '总费用', '手术结束时间1', '1级别', '细菌名称3', '5愈合', '是否非计划重返手术室病例2', '4愈合', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '6.1西药费', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '新生儿出生体重', '入院途径', '切口部位2', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '2愈合', '7.2中草药费', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '药占比%', '婚姻', '入院诊断', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1'}\n\n不一致的变量名:\n{'切口等级3', '7手术编码', '8手术名称', '麻醉开始时间3', '手术操作编码3', '切口部位3', '手术持续时间3', '麻醉分级3', '手术操作名称3', '7麻醉方式', '手术开始时间3', '手术部位感染3', '8级别', 'NNIS分级3', '4麻醉医师', '愈合2', '8麻醉方式', '手术结束时间3', '手术次数3', '7愈合', '7切口', '麻醉方式3', '7手术时间', '择期手术3', '7级别', '是否微创手术2', '麻醉结束时间3', '8手术时间', '8切口', '4麻醉方式', '7手术名称', '术前住院天数3', '8手术编码', '8愈合'}\n\n2018 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '手术部位感染3', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '愈合2', 'NNIS分级3', '2麻醉方式', '病理诊断', '3切口', '手术次数3', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '手术操作编码3', '切口部位3', '手术持续时间3', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '手术操作名称3', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '手术开始时间3', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '1.2一般治疗操作费', '4级别', '6级别', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '总费用', '手术结束时间1', '1级别', '细菌名称3', '5愈合', '是否非计划重返手术室病例2', '4愈合', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '麻醉分级3', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '麻醉方式3', '1.1一般医疗服务费', '6.1西药费', '是否微创手术2', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '4麻醉方式', '新生儿出生体重', '入院途径', '切口部位2', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '切口等级3', '2愈合', '7.2中草药费', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '麻醉开始时间3', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '手术结束时间3', '药占比%', '婚姻', '入院诊断', '6手术编码', '择期手术2', '择期手术3', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '麻醉结束时间3', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '术前住院天数3', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1'}\n\n2019 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '愈合2', '2麻醉方式', '病理诊断', '3切口', '手术次数3', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '手术操作编码3', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '手术操作名称3', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '手术开始时间3', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '1.2一般治疗操作费', '4级别', '6级别', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '7手术时间', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '总费用', '手术结束时间1', '1级别', '细菌名称3', '5愈合', '是否非计划重返手术室病例2', '4愈合', '7手术名称', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '7麻醉方式', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '7级别', '6.1西药费', '是否微创手术2', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '4麻醉方式', '新生儿出生体重', '入院途径', '切口部位2', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '7手术编码', '2愈合', '7.2中草药费', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '手术结束时间3', '药占比%', '婚姻', '入院诊断', '7愈合', '7切口', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1'}\n\n2020 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '2麻醉方式', '病理诊断', '3切口', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '8级别', '1.2一般治疗操作费', '8麻醉方式', '4级别', '6级别', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '7手术时间', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '8手术时间', '6麻醉方式', '8切口', '1级别', '总费用', '细菌名称3', '5愈合', '手术结束时间1', '是否非计划重返手术室病例2', '4愈合', '7手术名称', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '7麻醉方式', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '7级别', '6.1西药费', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '4麻醉方式', '新生儿出生体重', '入院途径', '切口部位2', '8愈合', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '7手术编码', '2愈合', '7.2中草药费', '8手术名称', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '药占比%', '婚姻', '入院诊断', '7愈合', '7切口', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1', '8手术编码'}\n\n2021 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '2麻醉方式', '病理诊断', '3切口', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '8级别', '1.2一般治疗操作费', '4级别', '6级别', '8麻醉方式', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '7手术时间', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '8手术时间', '8切口', '1级别', '总费用', '细菌名称3', '5愈合', '手术结束时间1', '是否非计划重返手术室病例2', '4愈合', '7手术名称', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '7麻醉方式', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '7级别', '6.1西药费', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '4麻醉方式', '新生儿出生体重', '入院途径', '切口部位2', '8愈合', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '7手术编码', '2愈合', '7.2中草药费', '8手术名称', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '药占比%', '婚姻', '入院诊断', '7愈合', '7切口', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1', '8手术编码'}\n\n2022 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '2麻醉方式', '病理诊断', '3切口', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '8级别', '1.2一般治疗操作费', '4级别', '6级别', '8麻醉方式', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '7手术时间', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '8手术时间', '8切口', '1级别', '总费用', '细菌名称3', '5愈合', '手术结束时间1', '是否非计划重返手术室病例2', '4愈合', '7手术名称', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '7麻醉方式', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '7级别', '6.1西药费', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '4麻醉方式', '新生儿出生体重', '入院途径', '切口部位2', '8愈合', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '7手术编码', '2愈合', '7.2中草药费', '8手术名称', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '药占比%', '婚姻', '入院诊断', '7愈合', '7切口', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1', '8手术编码'}\n\n2023 的变量: {'职业', '麻醉方式1', 'NNIS分级1', '6手术名称', '1.3护理费', '1.4其他费用', '3.4麻醉费', '3级别', '1手术时间', '是否有出院31天内再住院计划', '术前使用预防性抗菌药物2', '术前预防性抗菌药物给药时间1', '1手术名称', '2.3影像学诊断费', '病室', '4切口', '2.4临床诊断项目费', '5手术编码', '入院前颅脑损伤昏迷时间', '愈合1', '5手术名称', '麻醉开始时间1', '8.4凝血因子类制品费', '手术操作名称2', '3手术名称', '次数', '国籍', '3手术编码', '8.1血费', '是否临床路径', '手术次数1', '2麻醉方式', '病理诊断', '3切口', '5切口', '是否药物过敏', '6手术时间', '患者入住重症监护室（ICU）情况', '细菌名称1', '药物过敏', '是否非计划重返手术室病例1', '术前住院天数2', '3手术时间', '病室.1', '民族', '1麻醉方式', '切口部位1', '医疗付费方式', '4手术编码', '出院科别', '是否有使用抗菌药物2', '2手术名称', '清洁手术预防使用抗菌药物总天数', '2切口', '4手术名称', '2手术编码', '是否在术后使用预防性抗菌药物1', '5麻醉方式', '出院日期', '切口等级2', '3麻醉方式', '9.3手术用一次性医用材料费', '术前预防性抗菌药物给药时间2', '是否在术后使用预防性抗菌药物2', '级别1', '手术部位感染1', '断脐后预防性使用抗菌药物给药时间2', 'RH', '感染情况', '是否有使用抗菌药物1', '断脐后预防性使用抗菌药物给药时间1', '8级别', '1.2一般治疗操作费', '4级别', '6级别', '8麻醉方式', '8.5细胞因子类制品费', '手术开始时间1', '入院科别', '总药品费', '6愈合', '血型', '3.5手术费', '7手术时间', '手术预防性使用抗菌药物天数1', '自付金额', '4手术时间', '6麻醉方式', '8手术时间', '8切口', '1级别', '总费用', '细菌名称3', '5愈合', '手术结束时间1', '是否非计划重返手术室病例2', '4愈合', '7手术名称', '手术次数2', '是否微创手术1', '7.1中成药费', '预防性抗菌药物使用时机1', '3愈合', '腔镜手术名称1', '10.其他费', '手术操作名称1', '麻醉方式2', '2级别', '6.2抗菌药物费用', '出生地', '入院日期', '1愈合', '4.康复费', '输血反应', '输血反应次数', '抗菌药物使用天数', '本次住院期间有无重返手术室的计划1', '目的', '预防性抗菌药物使用时机2', '死亡患者尸检', '术前使用预防性抗菌药物1', '7麻醉方式', '手术开始时间2', '性别', '病案质量', '6切口', '择期手术1', '麻醉开始时间2', '籍贯', '1手术编码', '4麻醉医师', '9.1检查用一次性医用材料费', 'NNIS分级2', '3.1非手术治疗项目费', '住院天数', '手术操作编码1', '手术预防性使用抗菌药物天数2', '入院后颅脑损伤昏迷时间', '1.1一般医疗服务费', '7级别', '6.1西药费', '麻醉结束时间1', '细菌名称4', '血管介入治疗', '新生儿出生体重', '入院途径', '切口部位2', '8愈合', '8.3球蛋白类制品费', '血管介入治疗抗菌药物使用天数', '手术持续时间1', '年龄', '7手术编码', '2愈合', '7.2中草药费', '8手术名称', '2.2实验室诊断费', '手术结束时间2', '术后预防性抗菌药物结束时间2', '麻醉分级2', '3.2临床物理治疗费', '出生日期', '5手术时间', '手术操作编码2', '术前住院天数1', '2.1病理诊断费', '3.3手术治疗费', '细菌名称2', '腔镜手术名称2', '本次住院期间有无重返手术室的计划2', '8.2白蛋白类制品费', '麻醉结束时间2', '输液反应次数', '手术部位感染2', '手术持续时间2', '5级别', '术后预防性抗菌药物结束时间1', '输液反应', '麻醉分级1', '离院方式', '药占比%', '婚姻', '入院诊断', '7愈合', '7切口', '6手术编码', '择期手术2', '新生儿入院体重', '清洁手术预防使用抗菌药物品种数', '级别2', '5.中医治疗费', '出院诊断', '1切口', '2手术时间', '9.2治疗用一次性医用材料费', '院内感染', '切口等级1', '8手术编码'}\n```\n:::\n:::\n\n\n然后剔除不一致的变量数据，同时创建一个新变量`year`，用sheet的年份对其进行填充，再按变量名对应合并6张表格的数据称为一张总表，命名为`merge-sheet.xlsx`输出到你需要存放数据的文件夹中。\n\n变量还是太多了，那接下来对变量进行筛选，首先我们可以对所有键值为空的变量进行剔除，或者根据实际的研究需要，剔除一部分键值全部为null的变量。\n\n这里我选择对键值全部为null或0的变量进行剔除。\n\n第一次尝试的时候，打开表后进行查看，发现变量顺序很乱，没有按照原始顺序进行排列，处理办法则是在前面的变量筛选部分使用`DataFrame`的`loc`方法选择列，同时保持列的顺序。\n\n同时为了节省时间，因为在Quarto中运行Python代码很慢，暂时还不知道原因，待以后调试一下。所以最后用一个程序解决上述这些问题，节省时间。\n\n::: {#d653bad8 .cell execution_count=4}\n``` {.python .cell-code}\nimport pandas as pd\n\n# 导入 Excel 文件\nfile_path = \"C:/Users/asus/Desktop/test/stata/prepare.xlsx\"\noutput_path = \"C:/Users/asus/Desktop/test/stata/data/merge-data.xlsx\"\nfinal_output_path = \"C:/Users/asus/Desktop/test/stata/data/cleaned-merge-data.xlsx\"\nsheet_names = [\"2018\", \"2019\", \"2020\", \"2021\", \"2022\", \"2023\"]\n\n# 读取所有 sheet 的数据\nsheets_data = {sheet: pd.read_excel(file_path, sheet_name=sheet) for sheet in sheet_names}\n\n# 获取每个 sheet 的列名\nsheets_columns = {sheet: set(data.columns) for sheet, data in sheets_data.items()}\n\n# 找出所有 sheet 的共同变量\ncommon_columns = set.intersection(*sheets_columns.values())\n# 保持原始顺序\ncommon_columns = list(common_columns)  \n\n# 剔除不一致的变量数据，并添加 year 变量\nfor sheet, data in sheets_data.items():\n    sheets_data[sheet] = data[list(common_columns)]\n    sheets_data[sheet]['year'] = sheet\n\n# 合并所有 sheet 的数据\nmerged_data = pd.concat(sheets_data.values(), ignore_index=True)\n\n# 输出合并后的数据到指定路径\nmerged_data.to_excel(output_path, index=False)\n\n# 重新导入合并后的数据\nmerged_data = pd.read_excel(output_path)\n\n# 剔除键值全部为 null 或 0 的变量，同时保持原始变量的顺序\nnon_null_columns = merged_data.dropna(axis=1, how='all').columns\nnon_zero_columns = merged_data.loc[:, (merged_data != 0).any(axis=0)].columns\nvalid_columns = [col for col in merged_data.columns if col in non_null_columns and col in non_zero_columns]\n\ncleaned_data = merged_data.loc[:, valid_columns]\n\n# 输出清理后的数据到指定路径\ncleaned_data.to_excel(final_output_path, index=False)\n\nprint(f\"清理后的数据已输出到 {final_output_path}\")\n\n# 展示部分数据\n\n# 随机抽取10个样本数据\nsample_data = cleaned_data.sample(n=10)\n\n# 打印样本数据\nprint(sample_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n清理后的数据已输出到 C:/Users/asus/Desktop/test/stata/data/cleaned-merge-data.xlsx\n       职业 麻醉方式1 NNIS分级1 6手术名称  1.3护理费  3.4麻醉费 是否有出院31天内再住院计划  3级别  \\\n6937   农民   NaN     NaN   NaN    46.0     0.0              无  NaN   \n39768  农民   静脉麻      0级   NaN   141.0   700.0              无  NaN   \n11560  务农   NaN     NaN   NaN    50.0     0.0              无  NaN   \n23707  退休   NaN     NaN   NaN   200.0     0.0              无  NaN   \n36596  农民   NaN     NaN   NaN   110.0     0.0              无  NaN   \n45595  农民    局麻      0级   NaN    50.0    35.0              无  NaN   \n48442  其他    全麻      0级   NaN   137.3   325.0              无  NaN   \n40626  农民   NaN     NaN   NaN   195.0   350.0              无  NaN   \n27519  工人   NaN     NaN   NaN   621.0   626.0              无  2.0   \n32953  农民   NaN     NaN   NaN   182.8   315.0              无  NaN   \n\n                     1手术时间 术前预防性抗菌药物给药时间1  ... 择期手术2  新生儿入院体重 清洁手术预防使用抗菌药物品种数  \\\n6937   2019-08-21 10:00:00            NaN  ...   NaN        －             NaN   \n39768  2023-01-16 10:04:00            NaN  ...   NaN        －             NaN   \n11560  2020-01-04 10:07:00            NaN  ...   NaN        －             NaN   \n23707                  NaN            NaN  ...   NaN        －             NaN   \n36596                  NaN            NaN  ...   NaN        －             NaN   \n45595  2023-09-21 18:21:00            NaN  ...     是        －             NaN   \n48442  2023-12-12 09:35:00            NaN  ...     是        －             NaN   \n40626                  NaN            NaN  ...   NaN        －             0.0   \n27519  2021-02-25 18:40:00            NaN  ...   NaN        －             NaN   \n32953  2022-02-14 00:00:00            NaN  ...   NaN        －             NaN   \n\n       级别2                                               出院诊断  1切口  \\\n6937   NaN  老年性白内障|H25.900|有,玻璃体混浊|H43.300|有,特指手术后状态|Z98.8...    Ⅰ   \n39768  NaN  背部脓肿|L02.201|有,高血压|I10.x00x002|有,完全性右束支传导阻滞|I4...    Ⅰ   \n11560  NaN  老年性白内障|H25.900|有,玻璃体混浊|H43.300|有,翼状胬肉|H11.000|...    Ⅰ   \n23707  NaN  移植肾功能不全|T86.102|有,蛋白尿|R80.x02|有,高血压|I10.x00x00...  NaN   \n36596  NaN                                     毒蛇咬伤|T63.001|有  NaN   \n45595  3.0  老年核性白内障|H25.100|有,玻璃体混浊|H43.300x001|有,2型糖尿病|E1...    Ⅰ   \n48442  2.0  多发性结肠息肉|K63.504|有,直肠息肉|K62.100|有,慢性结肠炎|K52.910...    0   \n40626  NaN  腹膜炎|K65.900|临床未确定,肠梗阻|K56.700|临床未确定,腹腔积液|R18.x...  NaN   \n27519  NaN  开放性指骨骨折|S62.611|有,手指开放性伤口不伴有指甲损害|S61.000|有,开放性...    Ⅲ   \n32953  NaN  多发性结肠息肉|K63.504|有,直肠息肉|K62.100|有,慢性结肠炎|K52.910...    Ⅱ   \n\n                     2手术时间 院内感染 切口等级1  year  \n6937                   NaN  NaN   NaN  2019  \n39768                  NaN  NaN     Ⅰ  2023  \n11560                  NaN  NaN   NaN  2020  \n23707                  NaN  NaN   NaN  2021  \n36596                  NaN  NaN   NaN  2022  \n45595  2023-09-21 18:21:00  NaN     Ⅰ  2023  \n48442  2023-12-12 09:35:00  NaN     0  2023  \n40626                  NaN  NaN   NaN  2023  \n27519  2021-02-25 18:40:00  NaN   NaN  2021  \n32953  2022-02-14 00:00:00  NaN   NaN  2022  \n\n[10 rows x 160 columns]\n```\n:::\n:::\n\n\n",
    "supporting": [
      "2025-02-20-Medical-expenses_files\\figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}